# Harmony WeChat Mini Program

This sub-project provides a WeChat mini program that can preview Harmony editor scene bundles exported through `sceneStore.exportSceneBundle`. It is built on top of [`threejs-miniprogram`](https://github.com/wechat-miniprogram/threejs-miniprogram) and uses TypeScript for the scripting layer.

## Features

- Load Harmony scene bundles (JSON) generated by the editor's `exportSceneBundle`.
- Built-in sample scenes for quick verification.
- Scene picker with support for importing local JSON files or downloading from a URL.
- Runtime conversion from Harmony scene description to Three.js objects, including:
  - Mesh primitives (box, sphere, plane, etc.).
  - Ground / wall dynamic meshes.
  - Directional, point, spot, and ambient lights.
  - Embedded GLB models through `packageAssetMap` entries.
- Orbit-style touch controls for rotation, zoom, and pan.
- Basic lighting setup with shadow support and tone mapping.
- Responsive renderer sizing with pixel-ratio clamping for performance.

## Getting Started

1. Install dependencies:

   ```bash
   cd wechat-miniprogram
   npm install
   ```

2. Open the project in WeChat Developer Tools:

   - Choose **Import Project** and select the `wechat-miniprogram` folder.
   - Set an AppID (test IDs can use the "Trial" option).
   - Ensure the compilation target is set to **WeChat Mini Program**, with the TypeScript plugin enabled.

3. (Optional) Run type checking locally:

   ```bash
   npm run typecheck
   ```

## Scene Bundle Format

The mini program consumes bundles generated by the editor's `sceneStore.exportSceneBundle`. Supported capabilities include:

- `scene.nodes` for primitive geometry, lights, and dynamic meshes.
- `scene.materials` and per-node material overrides.
- Embedded resources via `packageAssetMap` using the `local::` prefix.
- Asset catalog lookups (for remote downloads) when URLs are accessible from the mini program domain allowlist.

If your bundle references external assets, make sure the corresponding domains are configured in the developer console.

## Project Structure

```
wechat-miniprogram/
├── app.json / app.ts / app.wxss
├── assets/
│   └── scenes/             # Sample bundles
├── components/
│   └── scene-viewer/       # Three.js canvas component
├── pages/
│   └── index/              # Scene selector UI
├── utils/
│   └── scene-loader.ts     # Harmony ➜ Three.js conversion logic
├── typings/                # Ambient declarations
└── tsconfig.json
```

## Notes & Limitations

- Texture loading currently focuses on embedded data URLs; additional slot handling can be extended in `scene-loader.ts`.
- Platform dynamic meshes are stubbed—extend `buildNodesForWall` / `buildGroundMesh` if you rely on more advanced mesh types.
- For large scenes, consider exporting bundles with embedded assets to avoid remote download latency.
- When targeting production, configure release optimization rules in `project.config.json` (e.g., minification, ES6 settings).

## Next Steps

- Integrate more Harmony runtime components (skyboxes, dynamic meshes, custom components).
- Expose scene statistics in the UI using the `statistics` returned from `buildSceneFromBundle`.
- Add offline caching for downloaded bundles.

Happy hacking!
